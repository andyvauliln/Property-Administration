{% extends "_base.html" %}
{% load static %}

{% block content %}
<div id="payment_sync_v2_page" class="w-full px-1 py-2 overflow-hidden flex flex-col min-h-0">

    <!-- Upload Section Card -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden mb-3 mx-1">
        <form method="POST" enctype="multipart/form-data" id="upload_form">
            {% csrf_token %}
            
            <div class="p-4 space-y-4">
                <!-- Initial State: Upload Only -->
                <div id="upload_initial_state" class="text-center {% if data.file_payments_json %}hidden{% endif %}">
                    <label class="block mb-4 text-lg font-semibold text-gray-700 dark:text-gray-300">
                        Start by uploading your bank statement CSV
                    </label>
                    <div class="max-w-xl mx-auto">
                        <label class="flex flex-col items-center justify-center w-full h-64 border-2 border-blue-300 border-dashed rounded-2xl cursor-pointer bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-gray-600 transition duration-300">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-12 h-12 mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">CSV file only</p>
                </div>
                            <input type="file" name="csv_file" accept=".csv" required class="hidden" onchange="this.form.submit()">
                    </label>
                    <div class="mt-6">
                        <a href="?demo=1" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                            Load Mock Data to Test
                        </a>
                    </div>
                    </div>
                </div>
                <!-- After Upload: Action Buttons in One Line -->
                <div id="upload_after_state" class="flex flex-wrap items-center gap-4 {% if not data.file_payments_json %}hidden{% endif %}">
                    <!-- Merge with AI -->
                    <button id="btn_merge_ai" type="button" onclick="mergeWithAI()"
                            class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600
                                   hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700
                                   text-gray-800 dark:text-gray-200 text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg
                                   shadow-md hover:shadow-lg transition duration-200
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Merge with AI
                    </button>

                    <!-- Merge with AI custom -->
                    <button id="btn_merge_ai_custom" type="button" onclick="openAICustomPromptModal()"
                            class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600
                                   hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700
                                   text-gray-800 dark:text-gray-200 text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg
                                   shadow-md hover:shadow-lg transition duration-200
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        Merge with AI custom
                    </button>

                    <!-- Merge manually -->
                    <button id="btn_merge_manual" type="button" onclick="mergeManually()"
                            class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600
                                   hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700
                                   text-gray-800 dark:text-gray-200 text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg
                                   shadow-md hover:shadow-lg transition duration-200
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Merge manually
                    </button>

                    <!-- Merge both -->
                    <button id="btn_merge_both" type="button" onclick="mergeBoth()"
                            class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600
                                   hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700
                                   text-gray-800 dark:text-gray-200 text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg
                                   shadow-md hover:shadow-lg transition duration-200
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Merge both
                    </button>

                    <!-- Edit Matching Criteria Button -->
                    <button type="button" onclick="openMatchingConfigModal()"
                            class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600
                                   hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700
                                   text-gray-800 dark:text-gray-200 text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg
                                   shadow-md hover:shadow-lg transition duration-200
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Edit Criteria
                    </button>

                    <!-- Upload File Button -->
                    <button type="button" onclick="document.getElementById('hidden_file_input').click()"
                            class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600
                                   hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700
                                   text-gray-800 dark:text-gray-200 text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg
                                   shadow-md hover:shadow-lg transition duration-200
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Upload New File
                    </button>
                    <input type="file" name="csv_file" id="hidden_file_input" accept=".csv" class="hidden" onchange="this.form.submit()">

                    <!-- Load Mock Data Button (also visible after resume/demo) -->
                    <a href="?demo=1"
                       class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600
                              hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700
                              text-gray-800 dark:text-gray-200 text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg
                              shadow-md hover:shadow-lg transition duration-200
                              focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        Load Mock Data
                    </a>

                    <div id="selection_required_hint" class="w-full text-xs text-gray-600 dark:text-gray-300">
                        Select at least 1 bank payment to enable merge actions.
                    </div>
                </div>

                <!-- Hidden Configuration Fields -->
                <div class="hidden">
                    <input type="checkbox" name="with_confirmed" id="with_confirmed" {% if data.with_confirmed %}checked{% endif %}>
                    <input type="number" name="amount_delta" id="amount_delta" value="{{ data.amount_delta|default:100 }}">
                    <input type="number" name="date_delta" id="date_delta" value="{{ data.date_delta|default:4 }}">
                    <input type="number" name="db_days_before" id="db_days_before" value="{{ data.db_days_before|default:30 }}">
                    <input type="number" name="db_days_after" id="db_days_after" value="{{ data.db_days_after|default:30 }}">
                    <!-- Add more hidden fields for config -->
                    <input type="text" name="ai_model" id="ai_model" value="{{ data.ai_model|default:'anthropic/claude-3.5-sonnet' }}">
                    <input type="text" name="ai_prompt" id="ai_prompt" value="{{ data.ai_prompt|default:'Match these payments based on amount, date, description, tenant, apartment, bank, payment method. The amount could be slightly different due to rounding or other factors. date could be also not the same day as the payment date.' }}">
                    <!-- Weights -->
                    <input type="number" name="weight_keywords" id="weight_keywords" value="{{ data.weight_keywords|default:5 }}">
                    <input type="number" name="weight_amount" id="weight_amount" value="{{ data.weight_amount|default:2 }}">
                    <input type="number" name="weight_date" id="weight_date" value="{{ data.weight_date|default:1 }}">
                    <input type="number" name="weight_tenant" id="weight_tenant" value="{{ data.weight_tenant|default:5 }}">
                    <input type="number" name="weight_apartment" id="weight_apartment" value="{{ data.weight_apartment|default:5 }}">
                </div>
            </div>

    <!-- Edit Matching Criteria Modal -->
    <div id="matchingConfigModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true" onclick="closeMatchingConfigModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <div class="p-6 max-h-[40vh] overflow-y-auto">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Matching Configuration</h3>
                        <button type="button" onclick="closeMatchingConfigModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <div class="space-y-8">
                        <!-- Settings Section -->
                        <section>
                            <div class="flex items-center gap-3 mb-4">
                                <h4 class="text-lg font-semibold text-gray-900">Settings</h4>
                            </div>
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">AI Model</label>
                                    <select id="modal_ai_model" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                        <optgroup label="OpenAI">
                                            <option value="openai/gpt-4o">GPT-4o · Best (OpenAI)</option>
                                            <option value="openai/gpt-4o-mini">GPT-4o mini · Budget (OpenAI)</option>
                                        </optgroup>
                                        <optgroup label="Anthropic Claude">
                                            <option value="anthropic/claude-3-opus">Claude 3 Opus · Best</option>
                                            <option value="anthropic/claude-3-haiku">Claude 3 Haiku · Budget</option>
                                        </optgroup>
                                        <optgroup label="Google Gemini">
                                            <option value="google/gemini-1.5-pro">Gemini 1.5 Pro · Best</option>
                                            <option value="google/gemini-1.5-flash">Gemini 1.5 Flash · Budget</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Prompt Template</label>
                                    <textarea id="modal_ai_prompt" rows="3" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">Match these payments based on amount, date, and description...</textarea>
                                </div>
                                <div>
                                    <h5 class="text-sm font-semibold text-gray-700 mb-3">Matching window & deltas</h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount Delta ($)</label>
                                            <input type="number" id="modal_amount_delta" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Delta (days)</label>
                                            <input type="number" id="modal_date_delta" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Days Before Start (DB)</label>
                                            <input type="number" id="modal_db_days_before" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Days After End (DB)</label>
                                            <input type="number" id="modal_db_days_after" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Weights Section -->
                        <section>
                            <div class="flex items-center gap-3 mb-4">
                                <h4 class="text-lg font-semibold text-gray-900">Weighting</h4>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide bg-purple-50 text-purple-700">Weights</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Keywords Weight</label>
                                    <input type="number" id="modal_weight_keywords" class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Exact Amount Weight</label>
                                    <input type="number" id="modal_weight_amount" class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Match Weight</label>
                                    <input type="number" id="modal_weight_date" class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tenant Weight</label>
                                    <input type="number" id="modal_weight_tenant" class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Apartment Weight</label>
                                    <input type="number" id="modal_weight_apartment" class="w-full rounded-lg border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- Footer Buttons -->
                    <div class="mt-8 pt-6 flex justify-end gap-4 border-t border-gray-200">
                        <button type="button" onclick="closeMatchingConfigModal()" class="mt-4 px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition">Cancel</button>
                        <button type="button" onclick="saveMatchingConfig()" class="mt-4 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">Save Config</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Custom Prompt Modal -->
    <div id="aiCustomPromptModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-gray-500/75" aria-hidden="true" onclick="closeAICustomPromptModal()"></div>
        <div class="relative flex min-h-full items-center justify-center p-4">
            <div class="w-full max-w-lg rounded-2xl bg-white text-left shadow-xl ring-1 ring-black/5">
                <div class="p-5 max-h-[70vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">AI Custom Prompt</h3>
                        <button type="button" onclick="closeAICustomPromptModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">This will be appended to the base prompt.</p>
                    <textarea id="ai_custom_prompt_input" rows="5" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Add any extra instructions..."></textarea>
                    <div class="mt-5 flex justify-end gap-3">
                        <button type="button" onclick="closeAICustomPromptModal()" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition">Cancel</button>
                        <button type="button" onclick="mergeWithAICustom()" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">Run AI custom</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Matching Workspace -->
    <div id="matching_workspace" class="space-y-3 px-1 flex-1 min-h-0 overflow-hidden flex flex-col {% if not data.file_payments_json %}hidden{% endif %}">
        <!-- Dual Columns -->
        <div id="columns_row" class="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
            <!-- Bank Column -->
            <section class="flex-1 min-w-0 bg-white rounded-2xl shadow-xl border border-gray-200 flex flex-col min-h-0">
                <header class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase text-gray-400 tracking-wide">Bank Payments</p>
                            <p class="text-2xl font-bold text-gray-900"><span id="bank_payments_count">0</span> items</p>
                        </div>
                        <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full text-sm text-gray-500">
                            <span class="h-2 w-2 rounded-full bg-green-500"></span>
                            <span id="bank_not_merged_badge">0 not merged</span>
                        </div>
                    </div>
                </header>
                <div class="px-5 py-4 border-b border-gray-100 space-y-3">
                    <input id="bank_filter_input" type="text" placeholder="All fields filter input"
                           onkeyup="filterBankPayments()"
                           class="w-full rounded-xl border border-gray-200 px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <div class="flex gap-2">
                        <button id="bank_filter_all" onclick="setBankFilter('all')" 
                                class="bank-filter-chip px-4 py-1.5 rounded-full text-sm font-semibold text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
                            All
                        </button>
                        <button id="bank_filter_not_merged" onclick="setBankFilter('not_merged')" 
                                class="bank-filter-chip px-4 py-1.5 rounded-full text-sm font-semibold bg-blue-600 text-white transition-colors">
                            Not Merged
                        </button>
                        <button id="bank_filter_merged" onclick="setBankFilter('merged')" 
                                class="bank-filter-chip px-4 py-1.5 rounded-full text-sm font-semibold text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
                            Merged
                        </button>
                    </div>
                </div>
                <div id="bank_payments_list" class="flex-1 overflow-y-auto px-5 py-4 space-y-4 custom-scroll"></div>
            </section>

            <!-- DB Column -->
            <section class="flex-1 min-w-0 bg-white rounded-2xl shadow-xl border border-gray-200 flex flex-col min-h-0">
                <header class="px-5 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase text-gray-400 tracking-wide">DB Payments</p>
                            <p class="text-2xl font-bold text-gray-900"><span id="db_payments_count">0</span> items</p>
                        </div>
                        <div class="inline-flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full text-sm text-gray-500">
                            <span class="h-2 w-2 rounded-full bg-violet-500"></span>
                            <span id="db_matched_badge">0 matched</span>
                        </div>
                    </div>
                </header>
                <div class="px-5 py-4 border-b border-gray-100 space-y-3">
                    <input id="db_filter_input" type="text" placeholder="All fields filter input"
                           onkeyup="filterDBPayments()"
                           class="w-full rounded-xl border border-gray-200 px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <div id="db_filter_buttons" class="flex gap-2"></div>
                </div>
                <div id="db_payments_list" class="flex-1 overflow-y-auto px-5 py-4 space-y-4 custom-scroll"></div>
            </section>
        </div>

        <!-- Merge Button -->
        <div id="merge_bar" class="flex justify-end pt-2 pb-2 flex-none">
            <button id="merge_button" onclick="mergeSelectedPayments()"
                    class="inline-flex items-center gap-2 px-6 py-3 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold shadow-lg hover:from-blue-700 hover:to-indigo-700 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Merge Selection
            </button>
        </div>
    </div>
</div>

<style>
    .custom-scroll::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.6);
        border-radius: 9999px;
    }
    /* Force scrolling on the list containers */
    #bank_payments_list, #db_payments_list {
        overflow-y: auto !important;
    }
</style>

<!-- Tailwind CSS safelist for dynamic classes (hidden) -->
<div class="hidden bg-green-600 border-green-600 hover:bg-green-700 hover:border-green-700 focus:ring-green-500 ring-green-400 text-green-600 bg-blue-600 border-blue-600 hover:bg-blue-700 hover:border-blue-700 focus:ring-blue-500 ring-blue-400 ring-2 ring-offset-2"></div>

<!-- Loading Overlay -->
<div id="loading_overlay" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-gray-900/50"></div>
    <div class="absolute inset-0 flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 px-4 py-3 w-[280px]">
            <div class="flex items-center gap-3">
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <div>
                    <div class="text-sm font-semibold text-gray-900 leading-tight" id="loading_title">Loading…</div>
                    <div class="text-xs text-gray-600 leading-tight" id="loading_subtitle">Please wait</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Matching Config Modal -->
<div id="configModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true" onclick="closeConfigModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">Matching Configuration</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Select AI Model</label>
                        <select class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md border">
                            <option>GPT-4o</option>
                            <option>GPT-3.5-Turbo</option>
                            <option>Claude 3.5 Sonnet</option>
                        </select>
                    </div>

<!-- Include JavaScript -->
<script>
    const STORAGE_KEY_FILE_PAYMENTS = 'payment_sync_v2_file_payments';
    const STORAGE_KEY_DB_PAYMENTS = 'payment_sync_v2_db_payments';
    const STORAGE_KEY_SETTINGS = 'payment_sync_v2_settings';
    const STORAGE_KEY_MATCHING_MODE = 'payment_sync_v2_matching_mode';
    const STORAGE_KEY_MATCH_CACHE = 'payment_sync_v2_match_cache';
    const MATCH_SELECTION_URL = "{% url 'match_selection_v2' %}";
    const FETCH_DB_URL = "{% url 'fetch_db_payments_for_matching' %}";

    // Global data (mutable)
    let db_payments_json = {{ data.db_payments_json|default:"[]"|safe }};
    let file_payments_json = {{ data.file_payments_json|default:"[]"|safe }};
    const payment_methods_json = {{ data.payment_methods|safe }};
    const apartments_json = {{ data.apartments|safe }};
    const payment_types_json = {{ data.payment_types|safe }};
    
    // Create dictionaries for quick lookup
    const payment_methods_dictionary = Object.fromEntries(payment_methods_json.map(i => [i.id, i.name]));
    const apartments_dictionary = Object.fromEntries(apartments_json.map(i => [i.id, i.name]));
    const payment_types_dictionary = Object.fromEntries(payment_types_json.map(i => [i.id, i.name + ' - ' + i.type]));
    
    // Selection state
    let selected_bank_payments = new Set();
    let selected_db_payments = new Set();

    // Selection-based matching state
    let current_selection_key = '';
    
    // Filter state
    let bank_filter_query = '';
    let db_filter_query = '';
    let bank_filter_type = 'not_merged';
    let db_filter_mode = 'all'; // all | manual | ai | both
    
    // Track which matching sources have been loaded
    let loaded_matching_sources = { manual: false, ai: false };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        fitPageToViewport();
        window.addEventListener('resize', fitPageToViewport);
        loadFromLocalStorage();
        bootstrapUI();
    });

    function fitPageToViewport() {
        // Simplest approach: compute list heights directly from viewport
        const bankList = document.getElementById('bank_payments_list');
        const dbList = document.getElementById('db_payments_list');
        
        if (!bankList && !dbList) return;
        
        // Get the top position of the first list to know where content starts
        const refList = bankList || dbList;
        const listTop = refList.getBoundingClientRect().top;
        
        // Leave space for merge button (about 70px) and some padding
        const listHeight = Math.max(200, window.innerHeight - listTop - 80);
        
        if (bankList) {
            bankList.style.height = listHeight + 'px';
            bankList.style.maxHeight = listHeight + 'px';
            bankList.style.overflowY = 'auto';
        }
        if (dbList) {
            dbList.style.height = listHeight + 'px';
            dbList.style.maxHeight = listHeight + 'px';
            dbList.style.overflowY = 'auto';
        }
    }

    function showLoading(title, subtitle) {
        document.getElementById('loading_title').textContent = title || 'Loading…';
        document.getElementById('loading_subtitle').textContent = subtitle || 'Please wait';
        document.getElementById('loading_overlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading_overlay').classList.add('hidden');
    }

    function setMatchButtonsState(state) {
        // state: 'idle' | 'manual' | 'ai' | 'loading' | 'refresh'
        const btnAI = document.getElementById('btn_match_ai');
        const btnManual = document.getElementById('btn_match_manual');
        if (!btnAI || !btnManual) return;

        const base = 'w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 border text-sm sm:text-base font-semibold whitespace-nowrap rounded-lg shadow-md hover:shadow-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-50';
        const idle = 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700 text-gray-800 dark:text-gray-200 focus:ring-blue-500';
        const activeManual = 'bg-blue-600 border-blue-600 text-white hover:bg-blue-700 hover:border-blue-700 focus:ring-blue-500';
        const activeAI = 'bg-green-600 border-green-600 text-white hover:bg-green-700 hover:border-green-700 focus:ring-green-500';
        const loadedIndicator = 'ring-2 ring-offset-2';
        const loading = 'opacity-60 cursor-not-allowed';

        // Reset to base state
        btnAI.className = `${base} ${idle}`;
        btnManual.className = `${base} ${idle}`;
        btnAI.disabled = false;
        btnManual.disabled = false;

        // Apply loaded state indicators based on loaded_matching_sources
        if (state === 'refresh') {
            // Just refresh based on loaded_matching_sources state
            if (loaded_matching_sources.manual) {
                btnManual.className = `${base} ${activeManual} ${loadedIndicator} ring-blue-400`;
            }
            if (loaded_matching_sources.ai) {
                btnAI.className = `${base} ${activeAI} ${loadedIndicator} ring-green-400`;
            }
        } else if (state === 'ai') {
            btnAI.className = `${base} ${activeAI} ${loadedIndicator} ring-green-400`;
            if (loaded_matching_sources.manual) {
                btnManual.className = `${base} ${activeManual} ${loadedIndicator} ring-blue-400`;
            }
        } else if (state === 'manual') {
            btnManual.className = `${base} ${activeManual} ${loadedIndicator} ring-blue-400`;
            if (loaded_matching_sources.ai) {
                btnAI.className = `${base} ${activeAI} ${loadedIndicator} ring-green-400`;
            }
        } else if (state === 'loading') {
            // keep current active styles if any, just disable both
            btnAI.className = `${btnAI.className} ${loading}`;
            btnManual.className = `${btnManual.className} ${loading}`;
            btnAI.disabled = true;
            btnManual.disabled = true;
        }

        // Update button text to show loaded status
        updateButtonLoadedIndicators();
    }

    function updateButtonLoadedIndicators() {
        const btnAI = document.getElementById('btn_match_ai');
        const btnManual = document.getElementById('btn_match_manual');
        if (!btnAI || !btnManual) return;

        // Determine icon colors based on loaded state
        const aiIconColor = loaded_matching_sources.ai ? 'text-white' : 'text-green-600';
        const manualIconColor = loaded_matching_sources.manual ? 'text-white' : 'text-blue-600';

        // Update AI button
        const aiIcon = loaded_matching_sources.ai 
            ? `<svg class="w-4 h-4 ${aiIconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
            : `<svg class="w-4 h-4 ${aiIconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`;
        const aiText = loaded_matching_sources.ai ? 'AI Loaded' : 'Match with AI';
        btnAI.innerHTML = `${aiIcon} ${aiText}`;

        // Update Manual button
        const manualIcon = loaded_matching_sources.manual
            ? `<svg class="w-4 h-4 ${manualIconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
            : `<svg class="w-4 h-4 ${manualIconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`;
        const manualText = loaded_matching_sources.manual ? 'Manual Loaded' : 'Match Manually';
        btnManual.innerHTML = `${manualIcon} ${manualText}`;
    }

    function setUIState(hasFilePayments) {
        const uploadInitial = document.getElementById('upload_initial_state');
        const uploadAfter = document.getElementById('upload_after_state');
        const workspace = document.getElementById('matching_workspace');

        if (hasFilePayments) {
            uploadInitial.classList.add('hidden');
            uploadAfter.classList.remove('hidden');
            workspace.classList.remove('hidden');
        } else {
            uploadInitial.classList.remove('hidden');
            uploadAfter.classList.add('hidden');
            workspace.classList.add('hidden');
        }
    }

    function getCSRFToken() {
        const name = 'csrftoken=';
        const decodedCookie = decodeURIComponent(document.cookie || '');
        const parts = decodedCookie.split(';');
        for (let i = 0; i < parts.length; i++) {
            let c = parts[i].trim();
            if (c.startsWith(name)) return c.substring(name.length);
        }
        return '';
    }

    function saveToLocalStorage() {
        try {
            localStorage.setItem(STORAGE_KEY_FILE_PAYMENTS, JSON.stringify(file_payments_json || []));
            localStorage.setItem(STORAGE_KEY_DB_PAYMENTS, JSON.stringify(db_payments_json || []));
            localStorage.setItem(STORAGE_KEY_MATCHING_MODE, JSON.stringify(loaded_matching_sources));
            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify({
                amount_delta: document.getElementById('amount_delta').value,
                date_delta: document.getElementById('date_delta').value,
                db_days_before: document.getElementById('db_days_before').value,
                db_days_after: document.getElementById('db_days_after').value,
                with_confirmed: document.getElementById('with_confirmed').checked,
                ai_model: document.getElementById('ai_model').value,
                ai_prompt: document.getElementById('ai_prompt').value,
                weight_keywords: document.getElementById('weight_keywords').value,
                weight_amount: document.getElementById('weight_amount').value,
                weight_date: document.getElementById('weight_date').value,
                weight_tenant: document.getElementById('weight_tenant').value,
                weight_apartment: document.getElementById('weight_apartment').value,
            }));
        } catch (e) {
            console.error('Failed saving to localStorage', e);
        }
    }

    function readMatchCache() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY_MATCH_CACHE);
            if (!raw) return { version: 1, by_selection: {} };
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object') return { version: 1, by_selection: {} };
            if (!parsed.by_selection || typeof parsed.by_selection !== 'object') parsed.by_selection = {};
            if (!parsed.version) parsed.version = 1;
            return parsed;
        } catch (e) {
            return { version: 1, by_selection: {} };
        }
    }

    function writeMatchCache(cacheObj) {
        try {
            localStorage.setItem(STORAGE_KEY_MATCH_CACHE, JSON.stringify(cacheObj || { version: 1, by_selection: {} }));
        } catch (e) {
            console.error('Failed saving match cache', e);
        }
    }

    function getCachedMatch(selectionKey, source) {
        const cache = readMatchCache();
        const entry = cache.by_selection?.[selectionKey];
        if (!entry) return null;
        return entry?.[source] || null;
    }

    function setCachedMatch(selectionKey, source, matchResult) {
        const cache = readMatchCache();
        if (!cache.by_selection[selectionKey]) cache.by_selection[selectionKey] = {};
        cache.by_selection[selectionKey][source] = matchResult;
        writeMatchCache(cache);
    }

    function normalizeCachedCandidateList(v) {
        // current cache format: array of candidates
        if (Array.isArray(v)) return v;
        // backward-compat: older cache stored { candidates: [...] }
        if (v && typeof v === 'object' && Array.isArray(v.candidates)) return v.candidates;
        return [];
    }

    function loadFromLocalStorage() {
        try {
            const storedPayments = localStorage.getItem(STORAGE_KEY_FILE_PAYMENTS);
            const storedDBPayments = localStorage.getItem(STORAGE_KEY_DB_PAYMENTS);
            const storedMatchingMode = localStorage.getItem(STORAGE_KEY_MATCHING_MODE);
            const storedSettings = localStorage.getItem(STORAGE_KEY_SETTINGS);

            // If user explicitly asked for demo, clear old data and start fresh
            const params = new URLSearchParams(window.location.search || '');
            const isDemo = params.get('demo') === '1';
            if (isDemo) {
                localStorage.removeItem(STORAGE_KEY_FILE_PAYMENTS);
                localStorage.removeItem(STORAGE_KEY_DB_PAYMENTS);
                localStorage.removeItem(STORAGE_KEY_MATCHING_MODE);
                localStorage.removeItem(STORAGE_KEY_MATCH_CACHE);
                // Reset loaded sources and clear DB payments for fresh demo
                loaded_matching_sources = { manual: false, ai: false };
                db_payments_json = [];
                selected_bank_payments = new Set();
                selected_db_payments = new Set();
                current_selection_key = '';
            }

            // If we have new file payments from server (CSV upload), clear DB payments
            const hasNewFilePayments = file_payments_json && file_payments_json.length > 0;
            const hasStoredFilePayments = storedPayments && JSON.parse(storedPayments).length > 0;
            
            if (hasNewFilePayments && hasStoredFilePayments) {
                // Check if file payments are different (new upload)
                const storedIds = JSON.parse(storedPayments).map(p => p.id).sort().join(',');
                const currentIds = file_payments_json.map(p => p.id).sort().join(',');
                if (storedIds !== currentIds) {
                    // New file uploaded - clear all local cache state except settings
                    db_payments_json = [];
                    loaded_matching_sources = { manual: false, ai: false };
                    current_selection_key = '';
                    selected_bank_payments = new Set();
                    selected_db_payments = new Set();
                    localStorage.removeItem(STORAGE_KEY_FILE_PAYMENTS);
                    localStorage.removeItem(STORAGE_KEY_DB_PAYMENTS);
                    localStorage.removeItem(STORAGE_KEY_MATCHING_MODE);
                    localStorage.removeItem(STORAGE_KEY_MATCH_CACHE);
                }
            }

            if ((!file_payments_json || file_payments_json.length === 0) && storedPayments) {
                const parsed = JSON.parse(storedPayments);
                if (Array.isArray(parsed)) file_payments_json = parsed;
            } else if (file_payments_json && file_payments_json.length > 0) {
                localStorage.setItem(STORAGE_KEY_FILE_PAYMENTS, JSON.stringify(file_payments_json));
            }

            // Load DB payments from localStorage if not already loaded from server
            if ((!db_payments_json || db_payments_json.length === 0) && storedDBPayments && !isDemo) {
                const parsed = JSON.parse(storedDBPayments);
                if (Array.isArray(parsed)) db_payments_json = parsed;
            } else if (db_payments_json && db_payments_json.length > 0 && !isDemo) {
                localStorage.setItem(STORAGE_KEY_DB_PAYMENTS, JSON.stringify(db_payments_json));
            }

            // Load matching mode state
            if (storedMatchingMode && !isDemo) {
                const parsed = JSON.parse(storedMatchingMode);
                if (parsed && typeof parsed === 'object') {
                    loaded_matching_sources = parsed;
                }
            }

            if (storedSettings) {
                const s = JSON.parse(storedSettings);
                if (s && typeof s === 'object') {
                    if (s.amount_delta !== undefined) document.getElementById('amount_delta').value = s.amount_delta;
                    if (s.date_delta !== undefined) document.getElementById('date_delta').value = s.date_delta;
                    if (s.db_days_before !== undefined) document.getElementById('db_days_before').value = s.db_days_before;
                    if (s.db_days_after !== undefined) document.getElementById('db_days_after').value = s.db_days_after;
                    if (s.with_confirmed !== undefined) document.getElementById('with_confirmed').checked = !!s.with_confirmed;

                    if (s.ai_model !== undefined) document.getElementById('ai_model').value = s.ai_model;
                    if (s.ai_prompt !== undefined) document.getElementById('ai_prompt').value = s.ai_prompt;
                    if (s.weight_keywords !== undefined) document.getElementById('weight_keywords').value = s.weight_keywords;
                    if (s.weight_amount !== undefined) document.getElementById('weight_amount').value = s.weight_amount;
                    if (s.weight_date !== undefined) document.getElementById('weight_date').value = s.weight_date;
                    if (s.weight_tenant !== undefined) document.getElementById('weight_tenant').value = s.weight_tenant;
                    if (s.weight_apartment !== undefined) document.getElementById('weight_apartment').value = s.weight_apartment;
                }
            }
        } catch (e) {
            console.error('Failed loading from localStorage', e);
        }
    }

    function ensureNewPaymentPlaceholder() {
        if (!Array.isArray(db_payments_json)) db_payments_json = [];
        const hasNew = db_payments_json.some(p => p && p.id === 'new');
        if (!hasNew) {
        db_payments_json.unshift({
            id: 'new',
            amount: 0,
            payment_date: new Date().toISOString().split('T')[0],
            notes: 'Create a new payment entry',
            apartment_name: '',
            tenant_name: '',
            payment_method: null,
            payment_type: null,
            payment_type_obj: { type: 'In' },
            payment_status: 'Pending',
            is_matched: false,
            matched_criteria: 'This will create a new payment record in the database'
        });
        }
    }

    function normalizeLocalFilePaymentsForUI() {
        if (!Array.isArray(file_payments_json)) file_payments_json = [];
        file_payments_json.forEach(p => {
            if (p.is_merged === undefined) p.is_merged = false;
            if (!p.payment_method_name && p.payment_method) {
                p.payment_method_name = payment_methods_dictionary[p.payment_method] || '';
            }
            if (!p.payment_type_name && p.payment_type) {
                p.payment_type_name = payment_types_dictionary[p.payment_type] || '';
            }
        });
    }

    function normalizeDBPaymentsForUI() {
        if (!Array.isArray(db_payments_json)) db_payments_json = [];
        db_payments_json.forEach(p => {
            if (!p) return;
            if (p.is_matched === undefined) p.is_matched = false;
            if (!p.payment_type_obj && p.payment_type) {
                p.payment_type_obj = { type: (payment_types_dictionary[p.payment_type]?.includes('Out') ? 'Out' : 'In') };
            }
        });
    }

    function bootstrapUI() {
        const hasFilePayments = Array.isArray(file_payments_json) && file_payments_json.length > 0;
        setUIState(hasFilePayments);
        if (!hasFilePayments) return;

        normalizeLocalFilePaymentsForUI();
        normalizeDBPaymentsForUI();
        ensureNewPaymentPlaceholder();
        saveToLocalStorage();

        // Restore button state based on loaded matching sources
        setMatchButtonsState('refresh');
        onBankSelectionChanged();
        renderBankPayments();
        renderDBPayments();
        updateCounts();
        requestAnimationFrame(fitPageToViewport);
    }
    
    function updateCounts() {
        const bankNotMerged = file_payments_json.filter(p => !p.is_merged).length;
        const dbMatched = db_payments_json.filter(p => p.id !== 'new' && p.is_matched).length;
        document.getElementById('bank_payments_count').textContent = file_payments_json.length;
        document.getElementById('db_payments_count').textContent = db_payments_json.length - 1;
        document.getElementById('bank_not_merged_badge').textContent = `${bankNotMerged} not merged`;
        document.getElementById('db_matched_badge').textContent = `${dbMatched} matched`;
    }

    // Bank Payments Functions
    function renderBankPayments() {
        let filtered = file_payments_json;
        
        // Apply merge status filter
        if (bank_filter_type === 'not_merged') {
            filtered = filtered.filter(p => !p.is_merged);
        } else if (bank_filter_type === 'merged') {
            filtered = filtered.filter(p => p.is_merged);
        }
        
        // Apply search filter
        if (bank_filter_query) {
            filtered = filtered.filter(p => {
                const searchStr = `${p.amount} ${p.payment_date} ${p.notes} ${p.apartment_name || ''} ${p.payment_method_name || ''} ${p.payment_type_name || ''}`.toLowerCase();
                return searchStr.includes(bank_filter_query);
            });
        }
        
        const container = document.getElementById('bank_payments_list');
        if (filtered.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500"><svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg><p class="font-medium">No payments found</p></div>';
            return;
        }
        
        let html = '';
        filtered.forEach(payment => {
            const isSelected = selected_bank_payments.has(payment.id);
            const isMerged = payment.is_merged;
            const amountColor = parseFloat(payment.amount) >= 0 ? 'text-green-600' : 'text-red-600';
            
            html += `
                <div class="border-2 ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-xl overflow-hidden hover:shadow-lg transition-all duration-200 bg-white cursor-pointer"
                     onclick="toggleBankPayment('${payment.id}')">
                    <div class="flex items-start p-4 gap-3">
                        <input type="checkbox" 
                               id="bank_${payment.id}"
                               ${isSelected ? 'checked' : ''}
                               onclick="event.stopPropagation()"
                               onchange="toggleBankPayment('${payment.id}')"
                               class="mt-1.5 w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-2 focus:ring-blue-500 cursor-pointer">
                        
                        <div class="flex-1 min-w-0">
                            <!-- Header with Amount and Status -->
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="text-2xl font-bold ${amountColor}">
                                        $${Math.abs(parseFloat(payment.amount)).toFixed(2)}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${payment.payment_type_name || 'Unknown Type'}
                                    </div>
                                </div>
                                <span class="px-3 py-1 text-xs font-bold rounded-full ${isMerged ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                    ${isMerged ? '✓ Merged' : '⚠ Not Merged'}
                                </span>
                            </div>
                            
                            <!-- Payment Details Grid -->
                            <div class="space-y-2">
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-medium text-gray-700">${formatDate(payment.payment_date)}</span>
                                </div>
                                
                                ${payment.apartment_name ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    <span class="text-gray-700"><strong>Apt:</strong> ${payment.apartment_name}</span>
                                </div>
                                ` : ''}
                                
                                ${payment.payment_method_name ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                    <span class="text-gray-700"><strong>Method:</strong> ${payment.payment_method_name}</span>
                                </div>
                                ` : ''}
                                
                                ${payment.notes ? `
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="flex items-start">
                                        <svg class="w-4 h-4 mr-2 mt-0.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-600 leading-relaxed">${payment.notes}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        updateCounts();
    }
    
    function filterBankPayments() {
        bank_filter_query = document.getElementById('bank_filter_input').value.toLowerCase();
        renderBankPayments();
    }
    
    function setBankFilter(type) {
        bank_filter_type = type;
        document.querySelectorAll('.bank-filter-chip').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-600');
        });
        const activeBtn = document.getElementById(`bank_filter_${type}`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
            activeBtn.classList.add('bg-blue-600', 'text-white');
        }
        renderBankPayments();
    }
    
    function computeSelectionKeyFromSelectedBankPayments() {
        return Array.from(selected_bank_payments || []).map(String).sort().join('+');
    }

    function getSelectedFilePaymentsForPayload() {
        const ids = new Set(Array.from(selected_bank_payments || []).map(String));
        return (file_payments_json || []).filter(p => ids.has(String(p.id)));
    }

    function updateSelectionActionButtons() {
        const hasSelection = (selected_bank_payments && selected_bank_payments.size > 0);
        const btnAI = document.getElementById('btn_merge_ai');
        const btnAICustom = document.getElementById('btn_merge_ai_custom');
        const btnManual = document.getElementById('btn_merge_manual');
        const btnBoth = document.getElementById('btn_merge_both');
        const hint = document.getElementById('selection_required_hint');

        [btnAI, btnAICustom, btnManual, btnBoth].forEach(btn => {
            if (!btn) return;
            btn.disabled = !hasSelection;
            btn.classList.toggle('opacity-50', !hasSelection);
            btn.classList.toggle('cursor-not-allowed', !hasSelection);
        });
        if (hint) hint.classList.toggle('hidden', hasSelection);
    }

    function onBankSelectionChanged() {
        current_selection_key = computeSelectionKeyFromSelectedBankPayments();
        updateSelectionActionButtons();
        updateDBDynamicFilters();
    }

    function toggleBankPayment(id) {
        const idStr = String(id);
        if (selected_bank_payments.has(idStr)) {
            selected_bank_payments.delete(idStr);
        } else {
            selected_bank_payments.add(idStr);
        }
        onBankSelectionChanged();
        renderBankPayments();
        renderDBPayments();
    }
    
    // DB Payments Functions
    function renderDBPayments() {
        const container = document.getElementById('db_payments_list');
        const candidateMode = db_filter_mode;
        const hasSelection = !!current_selection_key;
        const manualCandidates = hasSelection ? normalizeCachedCandidateList(getCachedMatch(current_selection_key, 'manual')) : [];
        const aiCandidates = hasSelection ? normalizeCachedCandidateList(getCachedMatch(current_selection_key, 'ai')) : [];

        let matchInfoById = {};
        let filtered = [];

        const newPlaceholder = (db_payments_json || []).find(p => p && p.id === 'new');

        if (candidateMode === 'all') {
            filtered = db_payments_json || [];
        } else if (!hasSelection) {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <p class="text-lg font-semibold mb-2">Select bank payments to see matches</p>
                    <p class="text-sm">Pick 1+ bank payments, then use the merge buttons above.</p>
                </div>
            `;
            updateCounts();
            return;
        } else {
            if (candidateMode === 'manual' && manualCandidates.length > 0) {
                const list = [...manualCandidates].sort((a, b) => (b.score || 0) - (a.score || 0));
                list.forEach(c => {
                    const id = String(c?.db_payment?.id);
                    if (!id) return;
                    matchInfoById[id] = { manual: c, ai: null, combined_score: c.score || 0 };
                });
                filtered = list.map(c => c.db_payment);
            } else if (candidateMode === 'ai' && aiCandidates.length > 0) {
                const list = [...aiCandidates].sort((a, b) => (b.score || 0) - (a.score || 0));
                list.forEach(c => {
                    const id = String(c?.db_payment?.id);
                    if (!id) return;
                    matchInfoById[id] = { manual: null, ai: c, combined_score: c.score || 0 };
                });
                filtered = list.map(c => c.db_payment);
            } else if (candidateMode === 'both') {
                const manualList = manualCandidates;
                const aiList = aiCandidates;

                const byId = {};
                manualList.forEach(c => {
                    const id = String(c?.db_payment?.id);
                    if (!id) return;
                    byId[id] = byId[id] || { db_payment: c.db_payment, manual: null, ai: null };
                    byId[id].manual = c;
                });
                aiList.forEach(c => {
                    const id = String(c?.db_payment?.id);
                    if (!id) return;
                    byId[id] = byId[id] || { db_payment: c.db_payment, manual: null, ai: null };
                    byId[id].ai = c;
                });

                const merged = Object.values(byId).map(x => {
                    const manualScore = x.manual ? (x.manual.score || 0) : null;
                    const aiScore = x.ai ? (x.ai.score || 0) : null;
                    let combined_score = 0;
                    if (manualScore !== null && aiScore !== null) combined_score = (manualScore + aiScore) / 2;
                    else combined_score = (manualScore !== null ? manualScore : (aiScore !== null ? aiScore : 0));
                    const id = String(x?.db_payment?.id);
                    matchInfoById[id] = { manual: x.manual, ai: x.ai, combined_score };
                    return { db_payment: x.db_payment, combined_score };
                });

                merged.sort((a, b) => (b.combined_score || 0) - (a.combined_score || 0));
                filtered = merged.map(x => x.db_payment);
            } else {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg font-semibold mb-2">No matches cached for this selection</p>
                        <p class="text-sm">Run a merge action (manual / AI / both) to populate suggestions.</p>
                    </div>
                `;
                updateCounts();
                return;
            }

            if (newPlaceholder) filtered = [newPlaceholder, ...filtered];
        }

        // Apply search filter (includes match criteria in candidate views)
        if (db_filter_query) {
            filtered = filtered.filter(p => {
                const matchInfo = matchInfoById[String(p.id)];
                const extra = matchInfo ? `${matchInfo.manual?.criteria || ''} ${matchInfo.ai?.criteria || ''}` : '';
                const searchStr = `${p.id} ${p.amount} ${p.payment_date} ${p.notes || ''} ${p.apartment_name || ''} ${p.tenant_name || ''} ${extra}`.toLowerCase();
                return searchStr.includes(db_filter_query);
            });
        }

        const loadedCount = (Array.isArray(db_payments_json) ? db_payments_json.filter(p => p && p.id !== 'new').length : 0);
        if (loadedCount === 0 && !db_filter_query && db_filter_mode === 'all') {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    <p class="text-lg font-semibold mb-2">No database payments loaded yet</p>
                    <p class="text-sm">Select bank payments and use merge actions to load suggestions.</p>
                </div>
            `;
            updateCounts();
            return;
        }
        if (filtered.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500"><svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg><p class="font-medium">No payments found</p></div>';
            return;
        }
        
        let html = '';
        filtered.forEach(payment => {
            const isSelected = selected_db_payments.has(String(payment.id));
            
            // Special card for "New Payment"
            if (payment.id === 'new') {
                html += `
                    <div class="border-2 ${isSelected ? 'border-green-500 bg-green-50' : 'border-green-300'} rounded-xl overflow-hidden hover:shadow-lg transition-all duration-200 bg-gradient-to-br from-green-50 to-emerald-50 cursor-pointer"
                         onclick="toggleDBPayment('new')">
                        <div class="flex items-start p-4 gap-3">
                            <input type="checkbox" 
                                   id="db_new"
                                   ${isSelected ? 'checked' : ''}
                                   onclick="event.stopPropagation()"
                                   onchange="toggleDBPayment('new')"
                                   class="mt-1.5 w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-2 focus:ring-green-500 cursor-pointer">
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="p-3 bg-green-500 rounded-full">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-xl font-bold text-green-700">New Payment</div>
                                        <div class="text-sm text-green-600">Create a new payment record</div>
                                    </div>
                                </div>
                                
                                <div class="p-3 bg-white rounded-lg border-2 border-green-200">
                                    <div class="text-sm text-gray-700">
                                        Select this option along with bank payment(s) to create a new payment entry in the database.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const payment_type_obj = payment.payment_type_obj || {};
            const amountColor = payment_type_obj.type === 'Out' ? 'text-red-600' : 'text-green-600';
            const amountPrefix = payment_type_obj.type === 'Out' ? '-' : '+';
            
            html += `
                <div class="border-2 ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-xl overflow-hidden hover:shadow-lg transition-all duration-200 bg-white cursor-pointer"
                     onclick="toggleDBPayment(${payment.id})">
                    <div class="flex items-start p-4 gap-3">
                        <input type="checkbox" 
                               id="db_${payment.id}"
                               ${isSelected ? 'checked' : ''}
                               onclick="event.stopPropagation()"
                               onchange="toggleDBPayment(${payment.id})"
                               class="mt-1.5 w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-2 focus:ring-blue-500 cursor-pointer">
                        
                        <div class="flex-1 min-w-0">
                            <!-- Header with ID, Amount and Status -->
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="text-xs font-bold text-gray-400 mb-1">ID #${payment.id}</div>
                                    <div class="text-2xl font-bold ${amountColor}">
                                        ${amountPrefix}$${Math.abs(parseFloat(payment.amount)).toFixed(2)}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${payment_types_dictionary[payment.payment_type] || 'Unknown Type'}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-1 items-end">
                                    ${payment.payment_status ? `
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                            payment.payment_status === 'Confirmed' ? 'bg-green-100 text-green-700' : 
                                            payment.payment_status === 'Pending' ? 'bg-yellow-100 text-yellow-700' : 
                                            'bg-gray-100 text-gray-700'
                                        }">
                                            ${payment.payment_status}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Payment Details -->
                            <div class="space-y-2">
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-medium text-gray-700">${formatDate(payment.payment_date)}</span>
                                </div>
                                
                                ${payment.apartment_name ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    <span class="text-gray-700"><strong>Apt:</strong> ${payment.apartment_name}</span>
                                </div>
                                ` : ''}
                                
                                ${payment.tenant_name ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <span class="text-gray-700"><strong>Tenant:</strong> ${payment.tenant_name}</span>
                                </div>
                                ` : ''}
                                
                                ${payment.payment_method ? `
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                    <span class="text-gray-700"><strong>Method:</strong> ${payment_methods_dictionary[payment.payment_method] || 'N/A'}</span>
                                </div>
                                ` : ''}
                                
                                ${payment.notes ? `
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="flex items-start">
                                        <svg class="w-4 h-4 mr-2 mt-0.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-600 leading-relaxed">${payment.notes}</span>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${(candidateMode !== 'all' && matchInfoById[String(payment.id)]) ? buildMatchBlocksHtml(matchInfoById[String(payment.id)], candidateMode) : `
                                    <div class="mt-3 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                                        <div class="text-xs font-bold text-indigo-700 mb-2 flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                            </svg>
                                            Matched Criteria
                                        </div>
                                        <div class="text-xs text-indigo-600">
                                            ${payment.matched_criteria || 'No matching criteria set yet'}
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        updateCounts();
    }
    
    function filterDBPayments() {
        db_filter_query = document.getElementById('db_filter_input').value.toLowerCase();
        renderDBPayments();
    }
    
    function setDBFilter(type) {
        db_filter_mode = type;
        updateDBDynamicFilters();
        renderDBPayments();
    }

    function escapeHtml(s) {
        const str = String(s ?? '');
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function buildMatchBlocksHtml(matchInfo, mode) {
        const hasManual = !!matchInfo?.manual;
        const hasAI = !!matchInfo?.ai;
        const combined = matchInfo?.combined_score;

        let header = '';
        if (mode === 'both' && (hasManual || hasAI)) {
            const combinedText = (typeof combined === 'number') ? combined.toFixed(1) : String(combined ?? '');
            header = `<div class="text-xs font-bold text-indigo-700 mb-2">Combined score: ${combinedText}</div>`;
        }

        const blocks = [];
        if (hasManual) {
            blocks.push(`
                <div class="p-3 rounded-lg border border-blue-200 bg-blue-50">
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-xs font-bold text-blue-700">Manual</div>
                        <div class="text-xs font-bold text-blue-800">${matchInfo.manual.score}</div>
                    </div>
                    <div class="text-xs text-blue-700">${escapeHtml(matchInfo.manual.criteria || '')}</div>
                </div>
            `);
        }
        if (hasAI) {
            blocks.push(`
                <div class="p-3 rounded-lg border border-green-200 bg-green-50">
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-xs font-bold text-green-700">AI</div>
                        <div class="text-xs font-bold text-green-800">${matchInfo.ai.score}</div>
                    </div>
                    <div class="text-xs text-green-700">${escapeHtml(matchInfo.ai.criteria || '')}</div>
                </div>
            `);
        }

        return `
            <div class="mt-3 p-3 bg-indigo-50 rounded-lg border border-indigo-200 space-y-2">
                ${header}
                ${blocks.join('')}
            </div>
        `;
    }

    function extractAIMatchFileId(matchedCriteria) {
        if (!matchedCriteria) return null;
        const s = String(matchedCriteria);
        const m = s.match(/AI suggestion:\s*file\s*([^\s,]+)/i);
        return m ? m[1] : null;
    }

    function extractManualMergedBankIds(matchedCriteria) {
        if (!matchedCriteria) return [];
        const s = String(matchedCriteria);
        const m = s.match(/Merged with Bank Payment\(s\):\s*(.*)$/i);
        if (!m || !m[1]) return [];
        return m[1].split(',').map(x => x.trim()).filter(Boolean);
    }

    function isAIMatchForSelectedBank(dbPayment, selectedBankIds) {
        if (!dbPayment || dbPayment.id === 'new') return false;
        const fileId = extractAIMatchFileId(dbPayment.matched_criteria);
        if (!fileId) return false;
        return selectedBankIds.includes(String(fileId));
    }

    function isManualMatchForSelectedBank(dbPayment, selectedBankIds) {
        if (!dbPayment || dbPayment.id === 'new') return false;
        const bankIds = extractManualMergedBankIds(dbPayment.matched_criteria);
        if (!bankIds.length) return false;
        return bankIds.some(id => selectedBankIds.includes(String(id)));
    }

    function updateDBDynamicFilters() {
        const container = document.getElementById('db_filter_buttons');
        if (!container) return;
        const hasSelection = !!current_selection_key;
        const manualCandidates = hasSelection ? normalizeCachedCandidateList(getCachedMatch(current_selection_key, 'manual')) : [];
        const aiCandidates = hasSelection ? normalizeCachedCandidateList(getCachedMatch(current_selection_key, 'ai')) : [];

        const hasManual = manualCandidates.length > 0;
        const hasAI = aiCandidates.length > 0;
        const hasBoth = hasManual || hasAI;

        if (!hasSelection) {
            db_filter_mode = 'all';
        } else {
            if (db_filter_mode === 'manual' && !hasManual) db_filter_mode = 'all';
            if (db_filter_mode === 'ai' && !hasAI) db_filter_mode = 'all';
            if (db_filter_mode === 'both' && !hasBoth) db_filter_mode = 'all';
        }

        const chipBase = 'db-filter-chip px-4 py-1.5 rounded-full text-sm font-semibold transition-colors';
        const chipActive = 'bg-blue-600 text-white';
        const chipIdle = 'text-gray-600 bg-gray-100 hover:bg-gray-200';
        const chipDisabled = 'opacity-50 cursor-not-allowed';

        const chips = [
            { id: 'all', label: 'All', enabled: true },
            { id: 'manual', label: 'Manual', enabled: hasSelection && hasManual },
            { id: 'ai', label: 'AI', enabled: hasSelection && hasAI },
            { id: 'both', label: 'Both', enabled: hasSelection && hasBoth },
        ];

        container.innerHTML = chips.map(c => {
            const active = (db_filter_mode === c.id);
            const cls = `${chipBase} ${active ? chipActive : chipIdle} ${c.enabled ? '' : chipDisabled}`;
            const disabledAttr = c.enabled ? '' : 'disabled';
            return `<button id="db_filter_${c.id}" onclick="setDBFilter('${c.id}')" class="${cls}" ${disabledAttr}>${c.label}</button>`;
        }).join('');
    }
    
    function toggleDBPayment(id) {
        // Convert to string for consistency
        const idStr = String(id);
        
        if (selected_db_payments.has(idStr)) {
            selected_db_payments.delete(idStr);
        } else {
            selected_db_payments.add(idStr);
        }
        renderDBPayments();
    }
    
    // Merge Function
    function mergeSelectedPayments() {
        if (selected_bank_payments.size === 0 || selected_db_payments.size === 0) {
            alert('Please select at least one payment from each side to merge.');
            return;
        }
        
        const bankIds = Array.from(selected_bank_payments);
        const dbIds = Array.from(selected_db_payments);
        
        // Confirm merge
        if (!confirm(`Are you sure you want to merge ${bankIds.length} bank payment(s) with ${dbIds.length} DB payment(s)?`)) {
            return;
        }
        
        // Mark bank payments as merged
        bankIds.forEach(id => {
            const payment = file_payments_json.find(p => p.id === id);
            if (payment) {
                payment.is_merged = true;
            }
        });
        
        // Mark DB payments as matched
        dbIds.forEach(id => {
            const payment = db_payments_json.find(p => String(p.id) === String(id));
            if (payment && payment.id !== 'new') {
                payment.is_matched = true;
                // Add matched criteria info
                payment.matched_criteria = `Merged with Bank Payment(s): ${bankIds.join(', ')}`;
            }
        });
        
        // Clear selections
        selected_bank_payments.clear();
        selected_db_payments.clear();
        
        // Re-render both lists
        renderBankPayments();
        renderDBPayments();
        
        // Show success message
        alert(`Successfully merged ${bankIds.length} bank payment(s) with ${dbIds.length} DB payment(s)!`);
        
        // TODO: Send merge data to backend
        console.log('Merge completed:', { bankIds, dbIds });
    }
    
    // Modal and Config Functions
    function openMatchingConfigModal() {
        const modalModelSelect = document.getElementById('modal_ai_model');
        const storedModel = document.getElementById('ai_model').value;
        if (storedModel) {
            const optionExists = Array.from(modalModelSelect.options).some(opt => opt.value === storedModel);
            if (!optionExists) {
                const customOption = new Option(`${storedModel} (Custom)`, storedModel);
                modalModelSelect.add(customOption, 0);
            }
            modalModelSelect.value = storedModel;
        } else {
            modalModelSelect.value = 'openai/gpt-4o';
        }

        document.getElementById('modal_ai_prompt').value = document.getElementById('ai_prompt').value;
        document.getElementById('modal_amount_delta').value = document.getElementById('amount_delta').value;
        document.getElementById('modal_date_delta').value = document.getElementById('date_delta').value;
        document.getElementById('modal_db_days_before').value = document.getElementById('db_days_before').value;
        document.getElementById('modal_db_days_after').value = document.getElementById('db_days_after').value;
        document.getElementById('modal_weight_keywords').value = document.getElementById('weight_keywords').value;
        document.getElementById('modal_weight_amount').value = document.getElementById('weight_amount').value;
        document.getElementById('modal_weight_date').value = document.getElementById('weight_date').value;
        document.getElementById('modal_weight_tenant').value = document.getElementById('weight_tenant').value;
        document.getElementById('modal_weight_apartment').value = document.getElementById('weight_apartment').value;

        document.getElementById('matchingConfigModal').classList.remove('hidden');
    }

    function closeMatchingConfigModal() {
        document.getElementById('matchingConfigModal').classList.add('hidden');
    }

    function saveMatchingConfig() {
        document.getElementById('ai_model').value = document.getElementById('modal_ai_model').value;
        document.getElementById('ai_prompt').value = document.getElementById('modal_ai_prompt').value;
        document.getElementById('amount_delta').value = document.getElementById('modal_amount_delta').value;
        document.getElementById('date_delta').value = document.getElementById('modal_date_delta').value;
        document.getElementById('db_days_before').value = document.getElementById('modal_db_days_before').value;
        document.getElementById('db_days_after').value = document.getElementById('modal_db_days_after').value;
        document.getElementById('weight_keywords').value = document.getElementById('modal_weight_keywords').value;
        document.getElementById('weight_amount').value = document.getElementById('modal_weight_amount').value;
        document.getElementById('weight_date').value = document.getElementById('modal_weight_date').value;
        document.getElementById('weight_tenant').value = document.getElementById('modal_weight_tenant').value;
        document.getElementById('weight_apartment').value = document.getElementById('modal_weight_apartment').value;
        
        closeMatchingConfigModal();
        saveToLocalStorage();
        alert('Configuration saved!');
    }

    function openAICustomPromptModal() {
        document.getElementById('ai_custom_prompt_input').value = '';
        document.getElementById('aiCustomPromptModal').classList.remove('hidden');
    }

    function closeAICustomPromptModal() {
        document.getElementById('aiCustomPromptModal').classList.add('hidden');
    }

    function mergeWithAICustom() {
        const customPrompt = document.getElementById('ai_custom_prompt_input').value || '';
        closeAICustomPromptModal();
        mergeSelectionMatch('ai', customPrompt);
    }

    function mergeWithAI() {
        mergeSelectionMatch('ai', '');
    }

    function mergeManually() {
        mergeSelectionMatch('manual', '');
    }

    function mergeBoth() {
        mergeSelectionMatch('both', '');
    }

    function mergeSelectionMatch(mode, aiCustomPrompt) {
        if (!selected_bank_payments || selected_bank_payments.size === 0) {
            alert('Select at least one bank payment first.');
            return;
        }

        const selectionKey = computeSelectionKeyFromSelectedBankPayments();
        const selectedFileIds = selectionKey ? selectionKey.split('+').filter(Boolean) : [];
        const selectedFilePayments = getSelectedFilePaymentsForPayload();

        // Cache hit logic
        if (mode === 'manual') {
            const cached = normalizeCachedCandidateList(getCachedMatch(selectionKey, 'manual'));
            if (cached.length > 0) {
                db_filter_mode = 'manual';
                updateDBDynamicFilters();
                renderDBPayments();
                return;
            }
        } else if (mode === 'ai') {
            // If AI custom prompt is provided, always re-run (cache doesn't store prompt in strict schema).
            const desiredPrompt = String(aiCustomPrompt || '').trim();
            if (!desiredPrompt) {
                const cached = normalizeCachedCandidateList(getCachedMatch(selectionKey, 'ai'));
                if (cached.length > 0) {
                    db_filter_mode = 'ai';
                    updateDBDynamicFilters();
                    renderDBPayments();
                    return;
                }
            }
        } else if (mode === 'both') {
            const cachedManual = normalizeCachedCandidateList(getCachedMatch(selectionKey, 'manual'));
            const cachedAI = normalizeCachedCandidateList(getCachedMatch(selectionKey, 'ai'));
            if (cachedManual.length > 0 || cachedAI.length > 0) {
                db_filter_mode = 'both';
                updateDBDynamicFilters();
                renderDBPayments();
                return;
            }
        }

        showLoading('Matching selection…', 'Fetching DB window and generating suggestions');

        const payload = {
            mode,
            selected_file_ids: selectedFileIds,
            selected_file_payments: selectedFilePayments,
            db_days_before: document.getElementById('db_days_before').value,
            db_days_after: document.getElementById('db_days_after').value,
            with_confirmed: document.getElementById('with_confirmed').checked,
            amount_delta: document.getElementById('amount_delta').value,
            date_delta: document.getElementById('date_delta').value,
            ai_model: document.getElementById('ai_model').value,
            ai_base_prompt: document.getElementById('ai_prompt').value,
            ai_custom_prompt: aiCustomPrompt || '',
        };

        fetch(MATCH_SELECTION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(payload),
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.error);
            const matchedPayments = Array.isArray(data.matched_payments) ? data.matched_payments : [];

            if (mode === 'manual') {
                setCachedMatch(selectionKey, 'manual', matchedPayments.filter(x => String(x?.type).toLowerCase() === 'manual'));
            } else if (mode === 'ai') {
                setCachedMatch(selectionKey, 'ai', matchedPayments.filter(x => String(x?.type).toLowerCase() === 'ai'));
            } else if (mode === 'both') {
                setCachedMatch(selectionKey, 'manual', matchedPayments.filter(x => String(x?.type).toLowerCase() === 'manual'));
                setCachedMatch(selectionKey, 'ai', matchedPayments.filter(x => String(x?.type).toLowerCase() === 'ai'));
            }

            // Build/refresh the "All" list from candidate db_payments
            const dbFromCandidates = [];
            matchedPayments.forEach(c => {
                if (c && c.db_payment) dbFromCandidates.push(c.db_payment);
            });
            if (dbFromCandidates.length > 0) {
                mergeDBPayments(dbFromCandidates);
                normalizeDBPaymentsForUI();
                ensureNewPaymentPlaceholder();
                saveToLocalStorage();
            }

            db_filter_mode = mode;
            updateDBDynamicFilters();
            renderDBPayments();
            hideLoading();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Failed to match selection');
        });
    }

    function matchManually() {
        if (!file_payments_json || file_payments_json.length === 0) {
            alert('Please upload a CSV first.');
            return;
        }

        saveToLocalStorage();
        setMatchButtonsState('loading');
        showLoading('Fetching database payments…', 'Loading payments from the database');

        const payload = {
            matching_mode: 'manual',
            file_payments: file_payments_json,
            db_days_before: document.getElementById('db_days_before').value,
            db_days_after: document.getElementById('db_days_after').value,
            with_confirmed: document.getElementById('with_confirmed').checked,
        };

        fetch(FETCH_DB_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(payload),
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.error);
            const newDBPayments = Array.isArray(data.db_payments) ? data.db_payments : [];
            
            // Merge new payments with existing ones, avoiding duplicates
            mergeDBPayments(newDBPayments);
            
            normalizeDBPaymentsForUI();
            ensureNewPaymentPlaceholder();
            
            // Mark manual as loaded
            loaded_matching_sources.manual = true;
            saveToLocalStorage();
            
            renderDBPayments();
            updateCounts();
            updateDBDynamicFilters();
            hideLoading();
            setMatchButtonsState('manual');
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            setMatchButtonsState('refresh');
            alert('Failed to fetch database payments');
        });
    }

    function matchWithAI() {
        if (!file_payments_json || file_payments_json.length === 0) {
            alert('Please upload a CSV first.');
            return;
        }

        saveToLocalStorage();
        setMatchButtonsState('loading');
        showLoading('Running AI matching…', 'Fetching DB payments and generating suggestions');

        const payload = {
            matching_mode: 'auto',
            file_payments: file_payments_json,
            db_days_before: document.getElementById('db_days_before').value,
            db_days_after: document.getElementById('db_days_after').value,
            with_confirmed: document.getElementById('with_confirmed').checked,
            amount_delta: document.getElementById('amount_delta').value,
            date_delta: document.getElementById('date_delta').value,
        };

        fetch(FETCH_DB_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(payload),
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.error);
            const newDBPayments = Array.isArray(data.db_payments) ? data.db_payments : [];
            
            // Merge new payments with existing ones, avoiding duplicates
            mergeDBPayments(newDBPayments);
            
            normalizeDBPaymentsForUI();
            ensureNewPaymentPlaceholder();
            
            // Mark AI as loaded
            loaded_matching_sources.ai = true;
            saveToLocalStorage();
            
            renderDBPayments();
            updateCounts();
            updateDBDynamicFilters();
            hideLoading();
            setMatchButtonsState('ai');
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            setMatchButtonsState('refresh');
            alert('Failed to run AI matching');
        });
    }
    
    function mergeDBPayments(newPayments) {
        // Get existing DB payment IDs (excluding 'new' placeholder)
        const existingIds = new Set(
            (db_payments_json || [])
                .filter(p => p && p.id !== 'new')
                .map(p => p.id)
        );
        
        // Start with existing payments (excluding 'new' placeholder)
        const merged = (db_payments_json || []).filter(p => p && p.id !== 'new');
        
        // Add or update payments from new data
        for (const newP of newPayments) {
            if (!newP || newP.id === 'new') continue;
            
            const existingIdx = merged.findIndex(p => p.id === newP.id);
            if (existingIdx >= 0) {
                // Merge matched_criteria if both have it
                const existing = merged[existingIdx];
                if (newP.matched_criteria && existing.matched_criteria) {
                    // Combine criteria if they're different
                    if (!existing.matched_criteria.includes(newP.matched_criteria) && 
                        !newP.matched_criteria.includes(existing.matched_criteria)) {
                        merged[existingIdx] = {
                            ...existing,
                            ...newP,
                            matched_criteria: `${existing.matched_criteria}; ${newP.matched_criteria}`,
                            is_matched: existing.is_matched || newP.is_matched
                        };
                    } else {
                        // Just update with new data
                        merged[existingIdx] = { ...existing, ...newP };
                    }
                } else {
                    // Just update with new data, keeping any existing matched_criteria
                    merged[existingIdx] = { 
                        ...existing, 
                        ...newP,
                        matched_criteria: newP.matched_criteria || existing.matched_criteria
                    };
                }
            } else {
                // Add new payment
                merged.push(newP);
            }
        }
        
        db_payments_json = merged;
    }
    
    // Utility Functions
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
    }
</script>
{% endblock %}

